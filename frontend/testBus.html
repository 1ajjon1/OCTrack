<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Locations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        html, body {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f5f5f5;
        }

        #header {
            width: 100%;
            padding: 15px;
            background: #2c3e50;
            color: white;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #busInfo {
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }

        .bus-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .bus-route {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .bus-destination {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .bus-time {
            font-size: 16px;
            color: #27ae60;
            font-weight: bold;
        }

        .bus-stop {
            font-size: 14px;
            color: #34495e;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ecf0f1;
        }

        #map {
            height: 40vh;
            width: 100%;
            margin-top: 20px;
        }

        #searchContainer {
            width: 100%;
            max-width: 600px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        input {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        button {
            padding: 10px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: bold;
        }

        button:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div id="header">
        <h2>Bus Arrivals</h2>
    </div>

    <div id="searchContainer">
        <h3>Search for a Bus</h3>
        <p>Stop Number/Name:</p>
        <input id="stopIn" type="text" placeholder="Enter Stop ID">
        <p>Route Number:</p>
        <input id="routeIn" type="text" placeholder="Enter Route Number">
        <button id="searchBtn">Search</button>
    </div>

    <div id="busInfo">
        <!-- Bus cards will be dynamically inserted here -->
    </div>
    

    <div id="map"></div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([45.410133361816406, -75.63468170166016], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
    
        let markers = [];
    
        document.getElementById("searchBtn").addEventListener("click", async function () {
            const stopNo = document.getElementById("stopIn").value;
            const routeNo = document.getElementById("routeIn").value;
    
            if (!stopNo) {
                alert("Please enter a stop number.");
                return;
            }
    
            try {
                const response = await fetch(`http://localhost:3001/api/stop?stopNo=${stopNo}`);
                const data = await response.json();
    
                const busInfo = document.getElementById("busInfo");
                busInfo.innerHTML = "";
    
                // Clear old map markers
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
    
                if (!data.buses || data.buses.length === 0) {
                    const noResults = document.createElement("div");
                    noResults.textContent = "No buses found for this stop.";
                    busInfo.appendChild(noResults);
                    return;
                }
    
                // Recenter map if location info is present
                if (data.stop_description && data.stop_description.Latitude && data.stop_description.Longitude) {
                    map.setView([data.stop_description.Latitude, data.stop_description.Longitude], 14);
                }
    
                data.buses.forEach(bus => {
                    // Filter by route number if one was entered
                    if (routeNo && bus.routeNo !== routeNo) return;

                    const direction = bus.routeHeading.split('-')[0].trim();
                    const destination = bus.routeHeading.split('-').slice(1).join('-').trim();
                    const stopDesc = data.stop_description.Description || "Current stop";

                    // Get array of trips (safely)
                    const trips = bus.nextTrips[0]?.Trip;
                    if (!Array.isArray(trips)) return;

                    trips.forEach(trip => {
                        const card = document.createElement("div");
                        card.className = "bus-card";

                        const route = document.createElement("div");
                        route.className = "bus-route";
                        route.textContent = `${bus.routeNo} ${direction}`;

                        const dest = document.createElement("div");
                        dest.className = "bus-destination";
                        dest.textContent = destination;

                        const time = document.createElement("div");
                        time.className = "bus-time";
                        time.textContent = trip.AdjustedScheduleTime
                            ? `Next: ${trip.AdjustedScheduleTime} min`
                            : `No upcoming time`;

                        const stop = document.createElement("div");
                        stop.className = "bus-stop";
                        stop.textContent = stopDesc;

                        card.appendChild(route);
                        card.appendChild(dest);
                        card.appendChild(time);
                        card.appendChild(stop);
                        busInfo.appendChild(card);

                        // Add marker if location is available
                        if (trip.Latitude && trip.Longitude) {
                            const marker = L.marker([trip.Latitude, trip.Longitude])
                                .addTo(map)
                                .bindPopup(`Bus ${bus.routeNo} - ${trip.AdjustedScheduleTime} min away`);
                            markers.push(marker);
                        }
                    });
                });

            } catch (error) {
                console.error("Error fetching stop data:", error);
                alert("Failed to fetch bus data. Please try again.");
            }
        });
    </script>
    
    
</body>
</html>